sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/core/UIComponent","it/horsa/gualapack/macchina/model/formatter","sap/ui/model/json/JSONModel","../services/SqlFieldType","../services/MesServices","it/horsa/gualapack/macchina/control/Info","../services/AppService"],function(t,e,i,a,s,n,o,l,r){"use strict";return t.extend("it.horsa.gualapack.macchina.controller.BaseController",{route:null,onInit:function(){r.init(this.getOwnerComponent());let t=new Date;t.setDate(t.getDate()+1);t=t.toISOString().substring(0,10);let e=document.location.hash.split("/").pop();e=e||"stampa";this.route=e;this.pars={data_inizio:(new Date).toISOString().substring(0,10),data_fine:t,cdl:e,data_inizio_tmp:(new Date).toISOString().substring(0,10),data_fine_tmp:t,cdl_tmp:e};const i=r.get("cdl");const a=new sap.ui.model.json.JSONModel;a.setData(i);this.getView().setModel(a,"cdl");this.pars.cdl=i.find(t=>t.key===e);this.pars.cdl_tmp=this.pars.cdl;o(e).then(t=>this.scheda(t));this.getRouter().getRoute(this.route).attachMatched(this._onRouteMatched,this)},_onRouteMatched:function(){if(sessionStorage.getItem("pars")){this.pars=JSON.parse(sessionStorage.getItem("pars"));sessionStorage.removeItem("pars")}this.fetch_data({params:[this.pars.data_inizio,this.pars.data_fine,null,this.route.charAt(0).toUpperCase()+this.route.substring(1)]})},onAfterRendering:function(){this.afterRendering=true;this.infos()},fetch_data:function(t){o("orders",t).then(t=>this.ordini(t))},infos:function(){if(this.getModel("scheda")){const t=document.querySelector("#"+this.getView().sId);if(!t){return}const e=this.getModel("scheda");e.getProperty("/stazione/info").forEach((t,e)=>{this.getView().byId("stazione__info").insertItem(new l({label:t.key,text:t.value,type:typeof t.value,size:"L"}),e)});e.getProperty("/stazione/data").forEach((t,e)=>{this.getView().byId("stazione__data").insertItem(new l({label:t.key,text:t.value,type:typeof t.value}),e)});e.getProperty("/macchina/info").forEach((t,e)=>{this.getView().byId("graph__info").insertItem(new l({label:t.key,text:t.value,type:typeof t.value}),e)})}},ordini:function(t){const e=this.getModel("scheda");const i=[];const a=new sap.ui.model.json.JSONModel;const s=this.getModel("scheda").oData;if(s.patches){t=this.patch_orders_data(t,s.patches)}a.setData(t);this.getView().setModel(a,"ordini");const o=this.getView().byId("tabella");if(o.getColCount()===0){const a=this.getResourceBundle();e.oData.columns.forEach((e,s)=>{const l=t.Rowsets.Rowset[0].Columns.Column.find(t=>t.Name===e);if(l){o.addColumn(new sap.m.Column({header:new sap.m.Label({text:a.getText(l.Name)||l.Name}),hAlign:l.SQLDataType>=3&&l.SQLDataType<10?"Right":"Left"}));i.push(n(l))}});o.bindItems("/Rowsets/Rowset/0/Row",new sap.m.ColumnListItem({cells:i}))}o.setModel(a);const l=sap.ui.core.format.DateFormat.getInstance({pattern:"dd/MM/yyyy"});o.setHeaderText("Ordini"+" dal "+l.format(new Date(this.pars.data_inizio))+" al "+l.format(new Date(this.pars.data_fine)));o.setFixedLayout(false);o.setAlternateRowColors(true)},scheda:function(t){const e=new sap.ui.model.json.JSONModel(t);this.setModel(e,"scheda");document.title=t.nome;var i=this.getView().byId("microchart");i.setModel(e);if(this.afterRendering){this.infos()}},gauge_change:function(t){const e=this.random_number(20,180);t.oSource.value=e;t.oSource.text=e>90?"In funzione":"Fermo Rispetto QualitÃ ";t.oSource.time=this.random_number(1,10)+" min."},random_number:function(t,e){t=Math.ceil(t);e=Math.floor(e);return Math.floor(Math.random()*(e-t+1))+t},formatter:a,getModel:function(t){return this.getView().getModel(t)},setModel:function(t,e){return this.getView().setModel(t,e)},getResourceBundle:function(){return this.getOwnerComponent().getModel("i18n").getResourceBundle()},navTo:function(t,e,i){this.getRouter().navTo(t,e,i)},getRouter:function(){return i.getRouterFor(this)},onNavBack:function(){var t=e.getInstance().getPreviousHash();if(t!==undefined){window.history.back()}else{this.getRouter().navTo("appHome",{},true)}},menu_TTS:function(){if(!this.TTS_dialog){const t=t=>new sap.m.Button({text:"{scheda>text}",type:t||"Default",width:"100%"});const e=new sap.ui.layout.FixFlex({fixContent:[new sap.m.Title({text:"Ordini",level:"H1"}).addStyleClass("grid_title"),new sap.ui.layout.Grid({defaultSpan:"XL6 L6 M12 S12",content:{path:"scheda>/ordini",template:t()}})]}).addStyleClass("ordini_bg").setLayoutData(new sap.ui.layout.GridData({span:"XL4 L4 M4 S6"}));const i=new sap.ui.layout.FixFlex({fixContent:[new sap.m.Title({text:"Funzioni",level:"H1"}).addStyleClass("grid_title"),new sap.ui.layout.Grid({defaultSpan:"XL4 L4 M6 S12",content:{path:"scheda>/funzioni",template:t()}})]}).addStyleClass("funzioni_bg").setLayoutData(new sap.ui.layout.GridData({span:"XL8 L8 M8 S6"}));const a=[e,i];const s=new sap.ui.layout.Grid({content:a});this.TTS_dialog=new sap.m.Dialog({title:"Menu TTS",content:s,endButton:new sap.m.Button({text:"Chiudi",press:function(){this.TTS_dialog.close()}.bind(this)})});this.getView().addDependent(this.TTS_dialog)}this.TTS_dialog.open()},menu_funzioniOrdineAttivo:function(){if(!this.funzioniOrdineAttivo_dialog){const t=t=>new sap.m.Button({text:"{scheda>text}",type:t||"Default",width:"100%"});this.funzioniOrdineAttivo_dialog=new sap.m.Dialog({title:"Funzioni ordine attivo",content:new sap.ui.layout.Grid({defaultSpan:"XL4 L4 M6 S12",content:{path:"scheda>/funzioni_ordine_attivo",template:t()}}),endButton:new sap.m.Button({text:"Chiudi",press:function(){this.funzioniOrdineAttivo_dialog.close()}.bind(this)})});this.getView().addDependent(this.funzioniOrdineAttivo_dialog)}this.funzioniOrdineAttivo_dialog.open()},menu_scelte:function(){if(!this.scelte_dialog){const t=new sap.m.FlexBox({justifyContent:"SpaceBetween",alignItems:"Center",items:[new sap.m.Label({text:"Data inizio"}).addStyleClass("modal_label"),new sap.m.DatePicker({placeholder:"Inserisci data inizio",value:this.pars.data_inizio,valueFormat:"yyyy-MM-dd",displayFormat:"long",change:function(t){this.pars.data_inizio_tmp=t.getParameters("value").value}.bind(this)}).addStyleClass("modal_text")]});const e=new sap.m.FlexBox({justifyContent:"SpaceBetween",alignItems:"Center",fitContainer:true,items:[new sap.m.Label({text:"Data fine"}).addStyleClass("modal_label"),new sap.m.DatePicker({placeholder:"Inserisci data fine",value:this.pars.data_fine,valueFormat:"yyyy-MM-dd",displayFormat:"long",change:function(t){this.pars.data_fine_tmp=t.getParameters("value").value}.bind(this)}).addStyleClass("modal_text")]});const i=new sap.m.FlexBox({justifyContent:"SpaceBetween",alignItems:"Center",fitContainer:true,items:[new sap.m.Label({text:"Centro di lavoro"}).addStyleClass("modal_label"),new sap.m.ComboBox({placeholder:"Scegli centro di lavoro",selectedKey:this.route,selectionChange:function(t){this.pars.cdl_tmp=t.getParameter("selectedItem").getKey()}.bind(this),items:{path:"cdl>/",template:new sap.ui.core.Item({key:"{cdl>key}",text:"{cdl>text}"})}}).addStyleClass("modal_text")]});const a=new sap.m.FlexBox({justifyContent:"SpaceBetween",alignItems:"Center",fitContainer:true,items:[new sap.m.Label({text:"Solo ordini aperti"}).addStyleClass("modal_label"),new sap.m.CheckBox({}).addStyleClass("modal_text")]});const s=new sap.m.FlexBox({direction:"Column",items:[t,e,a,i]}).addStyleClass("modal_scelte");this.scelte_dialog=new sap.m.Dialog({title:"Scelte",content:s,beforeOpen:function(t){if(t.getSource().getContent()[0].getItems().length){t.getSource().getContent()[0].getItems()[3].getItems()[1].setSelectedKey(this.route);this.pars.cdl=this.route;this.pars.cdl_tmp=this.route}}.bind(this),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:"OK",press:function(){this.scelte_dialog.close();this.pars.data_inizio=this.pars.data_inizio_tmp;this.pars.data_fine=this.pars.data_fine_tmp;if(this.route===this.pars.cdl_tmp){this.fetch_data({params:[this.pars.data_inizio,this.pars.data_fine,null,this.pars.cdl_tmp.charAt(0).toUpperCase()+this.pars.cdl_tmp.substring(1)]})}else{this.pars.cdl=this.pars.cdl_tmp;const t=Object.assign({},this.pars);delete t.cdl;delete t.cdl_tmp;sessionStorage.setItem("pars",JSON.stringify(t));const e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo(this.pars.cdl)}}.bind(this)}),endButton:new sap.m.Button({text:"Chiudi",press:function(){this.pars.cdl_tmp=this.pars.cdl;this.pars.data_inizio_tmp=this.pars.data_inizio;this.pars.data_fine_tmp=this.pars.data_fine;this.scelte_dialog.close()}.bind(this)})});this.getView().addDependent(this.scelte_dialog)}this.scelte_dialog.open()},patch_orders_data:function(t,e){e.forEach(e=>{t.Rowsets.Rowset[0].Columns.Column.push({Name:e,SQLDataType:-999});if(t.Rowsets.Rowset[0].hasOwnProperty("Row")){t.Rowsets.Rowset[0].Row.forEach(t=>t[e]=" ")}});return t}})});